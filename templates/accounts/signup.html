{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="register-container" align="center" style="text-align: center;">
    <div class="register-content" align="center" style="text-align: center;">
        <img src="{% static 'mainpage_design.png' %}" alt="main visual" class="mainpage-image" style="margin-bottom: 32px; display: block; margin-left: auto; margin-right: auto; width: 595px; height: 385px;" />
        
        <!-- Page Title -->
        <h1 class="register-title">Register</h1>
        
        <!-- Registration Form -->
        <div class="register-form-container" align="center" style="text-align: center;">
            <form method="post" class="register-form" align="center" style="text-align: center;" id="signup-form">
    {% csrf_token %}
                
                <!-- ID Field -->
                <div class="form-group">
                    <label for="id_field">ID :</label>
                    <div class="input-with-button">
                        <input type="text" id="id_field" name="username" placeholder="ID" required oninput="onIdInput()">
                        <button type="button" class="duplicate-check-btn" onclick="checkDuplicate('username', 'id_field')">ì¤‘ë³µê²€ì‚¬</button>
                    </div>
                </div>
                
                <!-- Email Field -->
                <div class="form-group">
                    <label for="email_field">Email :</label>
                    <input type="email" id="email_field" name="email" placeholder="Email" required>
                </div>
                
                <!-- Password Field -->
                <div class="form-group">
                    <label for="password_field">PW :</label>
                    <div class="password-input-container">
                        <input type="password" id="password_field" name="password1" placeholder="PW" required oninput="checkPasswordStrength()">
                        <span class="password-toggle-icon" onclick="togglePassword('password_field')">ğŸ‘ï¸</span>
                    </div>
                    <div class="password-requirements">
                        <div class="password-requirement" id="length-check">
                            <span class="requirement-icon">â—‹</span>
                            8ê¸€ì ì´ìƒ
                        </div>
                        <div class="password-requirement" id="char-check">
                            <span class="requirement-icon">â—‹</span>
                            ì˜ë¬¸/í•œê¸€ê³¼ ìˆ«ì í˜¼í•©
                        </div>
                        <div class="password-requirement" id="similarity-check">
                            <span class="requirement-icon">â—‹</span>
                            IDì™€ ìœ ì‚¬í•˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                    <div class="password-strength">
                        <div class="password-strength-bar" id="strength-bar"></div>
                    </div>
                </div>
                
                <!-- Password Confirmation Field -->
                <div class="form-group">
                    <label for="password_confirm_field">PWí™•ì¸ :</label>
                    <div class="password-check-container">
                        <div class="password-input-container">
                            <input type="password" id="password_confirm_field" name="password2" placeholder="PWí™•ì¸" required oninput="checkPasswordMatch()">
                            <span class="password-toggle-icon" onclick="togglePassword('password_confirm_field')">ğŸ‘ï¸</span>
                        </div>
                        <span class="password-check-icon" id="password-check-icon">âœ“</span>
                    </div>
                </div>
                
                <!-- Nickname Field -->
                <div class="form-group">
                    <label for="nickname_field">ë‹‰ë„¤ì„ :</label>
                    <div class="input-with-button">
                        <input type="text" id="nickname_field" name="nickname" placeholder="ë‹‰ë„¤ì„" required maxlength="8" oninput="onNicknameInput()">
                        <button type="button" class="duplicate-check-btn" onclick="checkDuplicate('nickname', 'nickname_field')">ì¤‘ë³µê²€ì‚¬</button>
                    </div>
                    <div class="password-requirements" id="nickname-requirements">
                        <div class="password-requirement" id="nickname-length-check">
                            <span class="requirement-icon">â—‹</span>
                            8ì ì´í•˜
                        </div>
                        <div class="password-requirement" id="nickname-char-check">
                            <span class="requirement-icon">â—‹</span>
                            í•œê¸€/ì˜ë¬¸/ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥
                        </div>
                    </div>
                </div>
                
                <!-- Register Button -->
                <button type="button" class="register-btn" onclick="validateAndSubmit()">íšŒì›ê°€ì…</button>
  </form>
            
            <div style="text-align: center; margin-top: 20px;">
                <p>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="{% url 'accounts:login' %}" style="color: #007bff; text-decoration: none;">ë¡œê·¸ì¸</a></p>
            </div>
        </div>
    </div>
</div>

<script>
// ì¤‘ë³µê²€ì‚¬ ìƒíƒœë¥¼ ì €ì¥í•  ë³€ìˆ˜
let duplicateCheckStatus = {
    username: false,
    nickname: false
};

let lastChecked = { username: '', nickname: '' };

async function checkDuplicate(type, inputId) {
    const input = document.getElementById(inputId);
    const button = input.parentNode.querySelector('.duplicate-check-btn');
    const value = input.value.trim();
    
    if (!value) {
        alert('ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
    button.disabled = true;
    button.textContent = 'ê²€ì‚¬ì¤‘...';
    
    try {
        const response = await fetch('{% url "accounts:check_duplicate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: type,
                value: value
            })
        });
        
        const data = await response.json();
        
        // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
        button.disabled = false;
        button.textContent = 'ì¤‘ë³µê²€ì‚¬';
        
        // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
        button.classList.remove('success', 'error');
        
        if (data.success) {
            // ì„±ê³µ - ì—°ë‘ìƒ‰
            button.classList.add('success');
            duplicateCheckStatus[type] = true;
            lastChecked[type] = value;
            alert(data.message);
        } else {
            // ì‹¤íŒ¨ - ë¶‰ì€ìƒ‰
            button.classList.add('error');
            duplicateCheckStatus[type] = false;
            lastChecked[type] = '';
            alert(data.message);
        }
        
    } catch (error) {
        console.error('Error:', error);
        button.disabled = false;
        button.textContent = 'ì¤‘ë³µê²€ì‚¬';
        alert('ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.parentNode.querySelector('.password-toggle-icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'ğŸ™ˆ';
    } else {
        input.type = 'password';
        icon.textContent = 'ğŸ‘ï¸';
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('password_field').value;
    const username = document.getElementById('id_field').value;
    const lengthCheck = document.getElementById('length-check');
    const charCheck = document.getElementById('char-check');
    const similarityCheck = document.getElementById('similarity-check');
    const strengthBar = document.getElementById('strength-bar');
    
    // ê¸¸ì´ ì²´í¬ (8ê¸€ì ì´ìƒ)
    const isLengthValid = password.length >= 8;
    lengthCheck.className = `password-requirement ${isLengthValid ? 'valid' : 'invalid'}`;
    lengthCheck.querySelector('.requirement-icon').textContent = isLengthValid ? 'âœ“' : 'â—‹';
    
    // ë¬¸ì í˜¼í•© ì²´í¬ (ì˜ë¬¸/í•œê¸€ê³¼ ìˆ«ì)
    const hasLetter = /[a-zA-Zê°€-í£]/.test(password);
    const hasNumber = /\d/.test(password);
    const isCharValid = hasLetter && hasNumber;
    charCheck.className = `password-requirement ${isCharValid ? 'valid' : 'invalid'}`;
    charCheck.querySelector('.requirement-icon').textContent = isCharValid ? 'âœ“' : 'â—‹';
    
    // IDì™€ ìœ ì‚¬ì„± ì²´í¬
    const isSimilarToUsername = password.toLowerCase().includes(username.toLowerCase()) || username.toLowerCase().includes(password.toLowerCase());
    similarityCheck.className = `password-requirement ${!isSimilarToUsername ? 'valid' : 'invalid'}`;
    similarityCheck.querySelector('.requirement-icon').textContent = !isSimilarToUsername ? 'âœ“' : 'â—‹';
    
    // ê°•ë„ í‘œì‹œ
    let strength = 0;
    if (isLengthValid) strength += 1;
    if (isCharValid) strength += 1;
    if (!isSimilarToUsername) strength += 1;
    
    strengthBar.className = 'password-strength-bar';
    if (strength === 1) {
        strengthBar.classList.add('weak');
    } else if (strength === 2) {
        strengthBar.classList.add('medium');
    } else if (strength === 3) {
        strengthBar.classList.add('strong');
    }
    
    // íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ë„ ë‹¤ì‹œ ì²´í¬
    checkPasswordMatch();
}

function checkPasswordMatch() {
    const password = document.getElementById('password_field').value;
    const confirmPassword = document.getElementById('password_confirm_field').value;
    const checkIcon = document.getElementById('password-check-icon');
    
    if (confirmPassword === '') {
        checkIcon.className = 'password-check-icon';
        return;
    }
    
    if (password === confirmPassword) {
        checkIcon.className = 'password-check-icon match';
    } else {
        checkIcon.className = 'password-check-icon mismatch';
    }
}

function onNicknameInput() {
    const input = document.getElementById('nickname_field');
    const button = input.parentNode.querySelector('.duplicate-check-btn');
    duplicateCheckStatus.nickname = false;
    button.classList.remove('success', 'error');
    button.textContent = 'ì¤‘ë³µê²€ì‚¬';
    lastChecked.nickname = '';
    // --- ì‹¤ì‹œê°„ ì¡°ê±´ í”¼ë“œë°± ---
    const val = input.value;
    const lengthCheck = document.getElementById('nickname-length-check');
    const charCheck = document.getElementById('nickname-char-check');
    const isLengthValid = val.length > 0 && val.length <= 8;
    const isCharValid = /^[a-zA-Z0-9ê°€-í£]+$/.test(val);
    lengthCheck.className = `password-requirement ${isLengthValid ? 'valid' : 'invalid'}`;
    lengthCheck.querySelector('.requirement-icon').textContent = isLengthValid ? 'âœ“' : 'â—‹';
    charCheck.className = `password-requirement ${isCharValid ? 'valid' : 'invalid'}`;
    charCheck.querySelector('.requirement-icon').textContent = isCharValid ? 'âœ“' : 'â—‹';
}

function onIdInput() {
    const input = document.getElementById('id_field');
    const button = input.parentNode.querySelector('.duplicate-check-btn');
    duplicateCheckStatus.username = false;
    button.classList.remove('success', 'error');
    button.textContent = 'ì¤‘ë³µê²€ì‚¬';
    lastChecked.username = '';
}

function validateAndSubmit() {
    // ëª¨ë“  í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const username = document.getElementById('id_field').value.trim();
    const email = document.getElementById('email_field').value.trim();
    const password = document.getElementById('password_field').value;
    const confirmPassword = document.getElementById('password_confirm_field').value;
    const nickname = document.getElementById('nickname_field').value.trim();
    
    // 1. í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!username || !email || !password || !confirmPassword || !nickname) {
        alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // 2. ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // 3. ì¤‘ë³µê²€ì‚¬ ê²€ì¦
    if (!duplicateCheckStatus.username || lastChecked.username !== username) {
        alert('ID ì¤‘ë³µê²€ì‚¬ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!duplicateCheckStatus.nickname || lastChecked.nickname !== nickname) {
        alert('ë‹‰ë„¤ì„ ì¤‘ë³µê²€ì‚¬ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // 4. íŒ¨ìŠ¤ì›Œë“œ ì¡°ê±´ ê²€ì¦
    const isLengthValid = password.length >= 8;
    const hasLetter = /[a-zA-Zê°€-í£]/.test(password);
    const hasNumber = /\d/.test(password);
    const isCharValid = hasLetter && hasNumber;
    const isSimilarToUsername = password.toLowerCase().includes(username.toLowerCase()) || username.toLowerCase().includes(password.toLowerCase());
    
    if (!isLengthValid) {
        alert('íŒ¨ìŠ¤ì›Œë“œëŠ” 8ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    if (!isCharValid) {
        alert('íŒ¨ìŠ¤ì›Œë“œëŠ” ì˜ë¬¸/í•œê¸€ê³¼ ìˆ«ìë¥¼ í˜¼í•©í•´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    if (isSimilarToUsername) {
        alert('íŒ¨ìŠ¤ì›Œë“œëŠ” IDì™€ ìœ ì‚¬í•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    // 5. íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ ê²€ì¦
    if (password !== confirmPassword) {
        alert('íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ëª¨ë“  ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ì¶•í•˜ íŒì—… í‘œì‹œ
    if (confirm('íšŒì›ê°€ì…ì„ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰\n\níšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')) {
        // í¼ ì œì¶œ
        document.getElementById('signup-form').submit();
    }
}
</script>
{% endblock %}